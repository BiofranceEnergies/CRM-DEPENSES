<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suivi Dépenses — Mois en cours</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#f59e0b; --ok:#10b981; --err:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:520px; margin:0 auto; padding:16px; }
    .h1 { font-size:22px; font-weight:700; margin:4px 0 12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 12px rgba(0,0,0,.25); }
    .row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    label { font-size:13px; color:var(--muted); }
    input, select { width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#0b1220; color:var(--text); outline:none; }
    input:focus, select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(245,158,11,.15); }
    .btn { width:100%; padding:14px; border:none; border-radius:12px; background:var(--accent); color:#111; font-weight:700; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .tot { margin-top:12px; padding:12px; border-radius:12px; background:#0b1220; border:1px dashed var(--border); display:flex; justify-content:space-between; align-items:center; }
    .tot .label { color:var(--muted); font-size:13px; }
    .tot .val { font-size:20px; font-weight:800; }
    .msg { margin-top:10px; font-size:14px; }
    .msg.ok { color:var(--ok); }
    .msg.err { color:var(--err); }
    .fine { margin-top:8px; font-size:12px; color:var(--muted); text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Dépenses — mois en cours</div>
    <div class="card">
      <form id="f" autocomplete="off">
        <div class="row">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" required>
        </div>
        <div class="row">
          <label for="montant">Montant (€)</label>
          <input id="montant" name="montant" type="number" step="0.01" inputmode="decimal" placeholder="0,00" required>
        </div>
        <div class="row">
          <label for="type">Type d’achat</label>
          <input id="type" name="type" type="text" maxlength="120" placeholder="Supermarché, carburant, …" required>
        </div>
        <button id="submit" class="btn" type="submit">Enregistrer</button>
      </form>

      <div class="tot" id="totalBox" aria-live="polite">
        <div class="label">Total du mois en cours</div>
        <div class="val" id="totalVal">—</div>
      </div>

      <div class="msg" id="msg"></div>
      <div class="fine">Le total repart à zéro automatiquement à chaque nouveau mois (les données restent dans le tableur).</div>
    </div>
  </div>

  <script>
    // URL Web App Apps Script
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyfcGG8eO8M68g2FHi-A6zXtC5Ye85BhtOJ0wzU0rTUTLfl57wxWZrLrFUr9T_pAMbkaw/exec';

    const $ = sel => document.querySelector(sel);
    const dateInput = $('#date');
    const montantInput = $('#montant');
    const typeInput = $('#type');
    const msg = $('#msg');
    const totalVal = $('#totalVal');
    const submitBtn = $('#submit');

    // Date par défaut = aujourd’hui
    (function setToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    })();

    function formatEUR(v){
      try { return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(v); }
      catch { return (Math.round(Number(v||0)*100)/100).toFixed(2) + ' €'; }
    }

    async function refreshTotal(){
      try {
        const r = await fetch(`${ENDPOINT}?monthTotal=1`, { method:'GET' });
        const j = await r.json();
        if (j && j.ok) totalVal.textContent = formatEUR(Number(j.monthTotal||0));
        else totalVal.textContent = '—';
      } catch (e) {
        totalVal.textContent = '—';
      }
    }

    async function submitForm(e){
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'msg';

      const date = dateInput.value.trim();
      const montant = montantInput.value.trim();
      const type = typeInput.value.trim();

      if (!date || !montant || !type) {
        msg.textContent = 'Champs manquants.';
        msg.classList.add('err');
        return;
      }

      submitBtn.disabled = true;

      try {
        // FormData => pas de Content-Type explicite => pas de preflight CORS
        const fd = new FormData();
        fd.append('date', date);
        fd.append('montant', montant);
        fd.append('type', type);

        const r = await fetch(ENDPOINT, { method: 'POST', body: fd });
        const j = await r.json();

        if (j.ok) {
          msg.textContent = 'Enregistré.';
          msg.classList.add('ok');
          montantInput.value = '';
          typeInput.value = '';
          await refreshTotal();
        } else {
          msg.textContent = j.error || 'Erreur à l’enregistrement.';
          msg.classList.add('err');
        }
      } catch (err) {
        msg.textContent = 'Erreur réseau ou autorisation.';
        msg.classList.add('err');
      } finally {
        submitBtn.disabled = false;
      }
    }

    document.getElementById('f').addEventListener('submit', submitForm);
    refreshTotal(); // charge le total au démarrage
  </script>
</body>
</html>
