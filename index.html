<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Suivi Dépenses</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --accent:#f59e0b; --ok:#10b981; --err:#ef4444; --border:#1f2937; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:600px; margin:0 auto; padding:16px; }
    .h1 { font-size:22px; font-weight:700; margin:4px 0 12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 12px rgba(0,0,0,.25); }
    .row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    label { font-size:13px; color:var(--muted); }
    input, select { width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#0b1220; color:var(--text); outline:none; }
    input:focus, select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(245,158,11,.15); }
    .btn { width:100%; padding:14px; border:none; border-radius:12px; background:var(--accent); color:#111; font-weight:700; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .tot { margin-top:12px; padding:12px; border-radius:12px; background:#0b1220; border:1px dashed var(--border); }
    .tot .label { color:var(--muted); font-size:13px; margin-top:6px; }
    .tot .val { font-size:20px; font-weight:800; margin-top:2px; }
    .msg { margin-top:10px; font-size:14px; }
    .msg.ok { color:var(--ok); }
    .msg.err { color:var(--err); }
    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    th, td { padding:6px; border-bottom:1px solid var(--border); text-align:left; }
    th { color:var(--muted); font-weight:500; }
    .fine { margin-top:8px; font-size:12px; color:var(--muted); text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">Suivi des Dépenses</div>
    <div class="card">
      <form id="f" autocomplete="off">
        <div class="row">
          <label for="date">Date</label>
          <input id="date" name="date" type="date" required>
        </div>
        <div class="row">
          <label for="montant">Montant (€)</label>
          <input id="montant" name="montant" type="number" step="0.01" inputmode="decimal" placeholder="0,00" required>
        </div>
        <div class="row">
          <label for="type">Type d’achat</label>
          <input id="type" name="type" type="text" maxlength="120" placeholder="Supermarché, carburant, …" required>
        </div>
        <div class="row">
          <label for="rglt">Type de règlement</label>
          <select id="rglt" name="rglt" required>
            <option value="">-- Choisir --</option>
            <option value="CB">CB</option>
            <option value="Chq">Chèque</option>
            <option value="Prlt">Prélèvement</option>
            <option value="Retrait">Retrait</option>
          </select>
        </div>
        <button id="submit" class="btn" type="submit">Enregistrer</button>
      </form>

      <div class="tot">
        <label for="monthSel">Mois</label>
        <select id="monthSel"></select>
        <label for="yearSel">Année</label>
        <select id="yearSel"></select>
        <div class="label">Total du mois sélectionné</div>
        <div class="val" id="totalVal">—</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Montant</th>
            <th>Achat</th>
            <th>Règlt</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>

      <div class="msg" id="msg"></div>
      <div class="fine">Toutes les écritures sont enregistrées dans Google Sheets.</div>
    </div>
  </div>

  <script>
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyfcGG8eO8M68g2FHi-A6zXtC5Ye85BhtOJ0wzU0rTUTLfl57wxWZrLrFUr9T_pAMbkaw/exec';

    const $ = sel => document.querySelector(sel);
    const dateInput = $('#date');
    const montantInput = $('#montant');
    const typeInput = $('#type');
    const rgltInput = $('#rglt');
    const msg = $('#msg');
    const totalVal = $('#totalVal');
    const submitBtn = $('#submit');
    const monthSel = $('#monthSel');
    const yearSel = $('#yearSel');

    // Sélecteurs mois/année
    const months = ['Jan','Fév','Mar','Avr','Mai','Juin','Juil','Août','Sep','Oct','Nov','Déc'];
    const now = new Date();
    for (let i=1;i<=12;i++){
      const opt=document.createElement('option');
      opt.value=i;
      opt.textContent=months[i-1];
      if(i===now.getMonth()+1) opt.selected=true;
      monthSel.appendChild(opt);
    }
    const thisYear=now.getFullYear();
    for(let y=thisYear-2;y<=thisYear+1;y++){
      const opt=document.createElement('option');
      opt.value=y;
      opt.textContent=y;
      if(y===thisYear) opt.selected=true;
      yearSel.appendChild(opt);
    }

    function formatEUR(v){
      try { return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(v); }
      catch { return (Math.round(Number(v||0)*100)/100).toFixed(2) + ' €'; }
    }

    async function refreshTotal(){
      const m=monthSel.value, y=yearSel.value;
      try {
        const r=await fetch(`${ENDPOINT}?month=${m}&year=${y}`);
        const j=await r.json();
        if(j && j.ok){
          totalVal.textContent=formatEUR(j.monthTotal||0);

          const tbody=document.getElementById('listBody');
          tbody.innerHTML='';
          j.data.forEach(item=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`
              <td>${item.date}</td>
              <td>${formatEUR(item.montant)}</td>
              <td>${item.type}</td>
              <td>${item.rglt}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          totalVal.textContent='—';
        }
      }catch{
        totalVal.textContent='—';
      }
    }

    async function submitForm(e){
      e.preventDefault();
      msg.textContent='';
      msg.className='msg';

      const date=dateInput.value.trim();
      const montant=montantInput.value.trim();
      const type=typeInput.value.trim();
      const rglt=rgltInput.value.trim();

      if(!date||!montant||!type||!rglt){
        msg.textContent='Champs manquants.';
        msg.classList.add('err');
        return;
      }

      submitBtn.disabled=true;

      try{
        const fd=new FormData();
        fd.append('date',date);
        fd.append('montant',montant);
        fd.append('type',type);
        fd.append('rglt',rglt);

        const r=await fetch(ENDPOINT,{method:'POST',body:fd});
        const j=await r.json();

        if(j.ok){
          msg.textContent='Enregistré.';
          msg.classList.add('ok');
          montantInput.value='';
          typeInput.value='';
          rgltInput.value='';
          await refreshTotal();
        }else{
          msg.textContent=j.error||'Erreur à l’enregistrement.';
          msg.classList.add('err');
        }
      }catch{
        msg.textContent='Erreur réseau ou autorisation.';
        msg.classList.add('err');
      }finally{
        submitBtn.disabled=false;
      }
    }

    document.getElementById('f').addEventListener('submit', submitForm);
    monthSel.addEventListener('change', refreshTotal);
    yearSel.addEventListener('change', refreshTotal);
    refreshTotal();
  </script>
</body>
</html>
